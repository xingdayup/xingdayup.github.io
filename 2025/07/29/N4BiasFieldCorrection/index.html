

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/me.png">
  <link rel="icon" href="/img/me.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Jesse Chen">
  <meta name="keywords" content="">
  
    <meta name="description" content="N4BiasFieldCorrection: MRI的N4偏场校正N4偏置场的定义和产生原因  MR scans often display intensity non-uniformities due to variations in the magnetic field. So, one part of an image might appear lighter or darker when">
<meta property="og:type" content="article">
<meta property="og:title" content="MRI的N4偏场校正">
<meta property="og:url" content="https://xingdayup.github.io/2025/07/29/N4BiasFieldCorrection/index.html">
<meta property="og:site_name" content="ChenJinxing&#39;s Blog">
<meta property="og:description" content="N4BiasFieldCorrection: MRI的N4偏场校正N4偏置场的定义和产生原因  MR scans often display intensity non-uniformities due to variations in the magnetic field. So, one part of an image might appear lighter or darker when">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-07-29T01:46:34.000Z">
<meta property="article:modified_time" content="2025-07-29T02:05:53.285Z">
<meta property="article:author" content="Jesse Chen">
<meta property="article:tag" content="原创">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>MRI的N4偏场校正 - ChenJinxing&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"xingdayup.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":"vdZLnTIdTwJmBWlW8LgSqJcp-gzGzoHsz","app_key":"SraJp3AuS35E7IyflZgQqEt2","server_url":"https://vdzlntid.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      ChenJinxing&#39;s Blog
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="MRI的N4偏场校正"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-07-29 09:46" pubdate>
          July 29, 2025 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          1.8k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          16 mins
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">MRI的N4偏场校正</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="N4BiasFieldCorrection-MRI的N4偏场校正"><a href="#N4BiasFieldCorrection-MRI的N4偏场校正" class="headerlink" title="N4BiasFieldCorrection: MRI的N4偏场校正"></a>N4BiasFieldCorrection: MRI的N4偏场校正</h1><p>N4偏置场的定义和产生原因</p>
<blockquote>
<p>MR scans often display intensity non-uniformities due to variations in the magnetic field. So, one part of an image might appear lighter or darker when visualized, solely because of variations in the magnetic field. The map of these variations is called <code>the bias field</code>. The bias field can cause problems for a classifier as the variations in signal intensity are not due to any anatomical differences.</p>
</blockquote>
<p>简单代码实现与讲解</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 导入 SimpleITK 库，它是一个用于医学图像分析的开源工具包。</span><br><span class="hljs-comment"># SimpleITK 提供了丰富的算法来进行图像分割、图像配准以及其他图像处理任务。</span><br><span class="hljs-comment"># &quot;as sitk&quot; 是为库设置一个简短的别名，方便后续代码的调用。</span><br><span class="hljs-keyword">import</span> SimpleITK <span class="hljs-keyword">as</span> sitk<br><span class="hljs-comment"># 定义一个字符串变量 imagePath，用于存储医学图像文件的完整路径。</span><br><span class="hljs-comment"># 在这个例子中，它指向的是一个 .nrrd 格式的文件。NRRD (Nearly Raw Raster Data) 是一种用于存储三维或更高维度图像数据的文件格式，常用于医学影像领域。</span><br>imagePath = <span class="hljs-string">&#x27;C:/Users/RONG/Desktop/Images/001/Lung_image.nrrd&#x27;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用之前定义的 imagePath 变量，读取原始的医学图像文件。</span><br><span class="hljs-comment"># sitk.ReadImage() 会返回一个 SimpleITK 的 Image 对象。</span><br>input_image = sitk.ReadImage(imagePath)<br><br><span class="hljs-comment"># 使用 Otsu 自动阈值算法为输入图像创建一个二值掩模（mask）。</span><br><span class="hljs-comment"># 这个掩模用于区分图像中的前景（如身体组织）和背景。</span><br><span class="hljs-comment"># Otsu 算法能自动找到一个最佳阈值来完成分割。</span><br><span class="hljs-comment"># 参数 (0, 1) 分别代表掩模中背景和前景的像素值，200 是计算时直方图的分箱数量。</span><br>mask_image = sitk.OtsuThreshold(input_image, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">200</span>)<br><br><span class="hljs-comment"># 将输入图像的像素数据类型转换为 32 位浮点型（float）。</span><br><span class="hljs-comment"># N4 偏置场校正算法要求输入图像是浮点型数据才能进行精确计算。</span><br>input_image = sitk.Cast(input_image, sitk.sitkFloat32)<br><br><span class="hljs-comment"># 创建一个 N4 偏置场校正滤波器的实例。</span><br><span class="hljs-comment"># 这个滤波器可以修正由于磁场不均匀等因素导致的图像灰度缓慢变化的问题。</span><br>corrector = sitk.N4BiasFieldCorrectionImageFilter()<br><br><span class="hljs-comment"># 执行校正算法。</span><br><span class="hljs-comment"># 它需要两个参数：待校正的图像 (input_image) 和一个掩模 (mask_image)。</span><br><span class="hljs-comment"># 掩模会告诉算法只在感兴趣的区域（前景）内进行校正，从而提高效率和准确性。</span><br>output_image = corrector.Execute(input_image, mask_image)<br><br><span class="hljs-comment"># 将校正完成后的图像数据类型从浮点型转回 16 位有符号整型（short integer）。</span><br><span class="hljs-comment"># 这是一种常见的医学图像存储格式，可以减小文件体积。</span><br>output_image = sitk.Cast(output_image, sitk.sitkInt16)<br><br><span class="hljs-comment"># 将校正后的图像保存到硬盘。</span><br><span class="hljs-comment"># 文件名是 &#x27;Lung_N4.nii.gz&#x27;，格式为 NIfTI（.nii），并使用 gzip (.gz) 进行压缩。</span><br>sitk.WriteImage(output_image, <span class="hljs-string">&#x27;C:/Users/RONG/Desktop/Images/001/Lung_N4.nii.gz&#x27;</span>)<br><br><span class="hljs-comment"># 同时，将生成的掩模图像也保存下来。</span><br><span class="hljs-comment"># 这在后续的分割、分析或可视化步骤中可能会用到。</span><br>sitk.WriteImage(mask_image, <span class="hljs-string">&#x27;C:/Users/RONG/Desktop/Images/001/Lung_mask.nii.gz&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>以上可以在<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1e54y1478Q/?vd_source=51248ed8b92745978a0d322c92152e66">B站</a>可见</p>
<p><strong>批处理</strong></p>
<p>好的，没有问题。为了实现批处理，我们需要对代码进行一些修改，使其能够：</p>
<ol>
<li>遍历一个文件夹中的所有文件。</li>
<li>通过文件名中的特定前缀来筛选要处理的文件。</li>
<li>根据原始文件名生成新的输出文件名（前面加上”N4_”）。</li>
</ol>
<p>下面是修改后的完整代码，以及详细的使用说明。</p>
<hr>
<h3 id="批处理-Python-脚本"><a href="#批处理-Python-脚本" class="headerlink" title="批处理 Python 脚本"></a>批处理 Python 脚本</h3><p> <code>batch_n4_correction.py</code></p>
<p>Python</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 导入所需的库</span><br><span class="hljs-keyword">import</span> SimpleITK <span class="hljs-keyword">as</span> sitk<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> glob<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">perform_n4_correction</span>(<span class="hljs-params">input_path, output_path</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    对单个图像文件执行 N4 偏置场校正。</span><br><span class="hljs-string"></span><br><span class="hljs-string">    参数:</span><br><span class="hljs-string">    input_path (str): 输入图像的完整路径。</span><br><span class="hljs-string">    output_path (str): 校正后图像的保存路径。</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">50</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;正在处理: <span class="hljs-subst">&#123;os.path.basename(input_path)&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 1. 读取图像</span><br>        input_image = sitk.ReadImage(input_path)<br><br>        <span class="hljs-comment"># 2. 使用 Otsu 自动阈值创建掩模 (mask)</span><br>        <span class="hljs-comment"># 这是一个稳健的方法，可以自动区分前景和背景</span><br>        mask_image = sitk.OtsuThreshold(input_image, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">200</span>)<br><br>        <span class="hljs-comment"># 3. 将输入图像类型转换为浮点型（N4算法要求）</span><br>        input_image_float = sitk.Cast(input_image, sitk.sitkFloat32)<br><br>        <span class="hljs-comment"># 4. 创建并执行 N4 校正器</span><br>        corrector = sitk.N4BiasFieldCorrectionImageFilter()<br>        output_image = corrector.Execute(input_image_float, mask_image)<br><br>        <span class="hljs-comment"># 5. 将校正后的图像转回原始数据类型或常用的 Int16</span><br>        <span class="hljs-comment"># 这里我们转回 Int16，这是医学图像常用的存储格式</span><br>        output_image = sitk.Cast(output_image, sitk.sitkInt16)<br><br>        <span class="hljs-comment"># 6. 保存校正后的图像</span><br>        sitk.WriteImage(output_image, output_path)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;处理完成, 已保存至: <span class="hljs-subst">&#123;os.path.basename(output_path)&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-comment"># 如果处理过程中发生任何错误，打印错误信息并继续处理下一个文件</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;处理文件 <span class="hljs-subst">&#123;os.path.basename(input_path)&#125;</span> 时发生错误: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br><br><span class="hljs-comment"># ===================================================================</span><br><span class="hljs-comment"># 主程序入口</span><br><span class="hljs-comment"># ===================================================================</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-comment"># --- 用户配置区域 ---</span><br>    <span class="hljs-comment"># 1. 设置包含原始图像的文件夹路径</span><br>    <span class="hljs-comment">#    &#x27;.&#x27; 表示当前文件夹 (脚本所在的文件夹)</span><br>    input_directory = <span class="hljs-string">&#x27;./data&#x27;</span><br><br>    <span class="hljs-comment"># 2. 设置存放校正后图像的文件夹路径</span><br>    <span class="hljs-comment">#    如果文件夹不存在，程序会自动创建</span><br>    output_directory = <span class="hljs-string">&#x27;./output&#x27;</span><br><br>    <span class="hljs-comment"># 3. 设置你想要处理的文件的【特定前缀】</span><br>    <span class="hljs-comment">#    例如，如果你的文件是 &#x27;T1_001.nii.gz&#x27;, &#x27;T1_002.nii.gz&#x27; ...</span><br>    <span class="hljs-comment">#    那么前缀就是 &#x27;T1_&#x27;</span><br>    <span class="hljs-comment">#    如果要处理文件夹下所有 .nii.gz 文件，可以将前缀设置为空字符串 &#x27;&#x27;</span><br>    file_prefix = <span class="hljs-string">&#x27;sub&#x27;</span><br>    <br>    <span class="hljs-comment"># 4. 设置文件的扩展名</span><br>    file_extension = <span class="hljs-string">&#x27;.nii.gz&#x27;</span><br>    <span class="hljs-comment"># --- 配置结束 ---</span><br><br><br>    <span class="hljs-comment"># 检查并创建输出文件夹</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(output_directory):<br>        os.makedirs(output_directory)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;已创建输出文件夹: <span class="hljs-subst">&#123;output_directory&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># 构建文件搜索模式</span><br>    <span class="hljs-comment"># 例如: &#x27;./data/sub*.nii.gz&#x27;</span><br>    search_pattern = os.path.join(input_directory, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;file_prefix&#125;</span>*<span class="hljs-subst">&#123;file_extension&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-comment"># 使用 glob 查找所有匹配前缀和扩展名的文件</span><br>    file_list = glob.glob(search_pattern)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> file_list:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;在文件夹 &#x27;<span class="hljs-subst">&#123;input_directory&#125;</span>&#x27; 中未找到任何以 &#x27;<span class="hljs-subst">&#123;file_prefix&#125;</span>&#x27; 开头的文件。&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;找到 <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(file_list)&#125;</span> 个匹配的文件，开始批处理...&quot;</span>)<br>        <span class="hljs-comment"># 遍历找到的每个文件</span><br>        <span class="hljs-keyword">for</span> input_file_path <span class="hljs-keyword">in</span> file_list:<br>            <span class="hljs-comment"># 获取不带路径的文件名</span><br>            base_name = os.path.basename(input_file_path)<br>            <br>            <span class="hljs-comment"># 构建新的输出文件名 (前面加上 &#x27;N4_&#x27;)</span><br>            output_name = <span class="hljs-string">f&quot;N4_<span class="hljs-subst">&#123;base_name&#125;</span>&quot;</span><br>            <br>            <span class="hljs-comment"># 构建完整的输出文件路径</span><br>            output_file_path = os.path.join(output_directory, output_name)<br>            <br>            <span class="hljs-comment"># 调用函数进行 N4 校正</span><br>            perform_n4_correction(input_file_path, output_file_path)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">50</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;所有任务已完成！&quot;</span>)<br></code></pre></td></tr></table></figure>



<h3 id="如何使用这个脚本"><a href="#如何使用这个脚本" class="headerlink" title="如何使用这个脚本"></a>如何使用这个脚本</h3><ol>
<li><p>文件和文件夹结构：</p>
<p>为了方便管理，建议你创建如下的文件夹结构：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs lua">主文件夹/<br>├── data/                 &lt;<span class="hljs-comment">-- 把所有原始图像文件放在这里</span><br>│   ├── <span class="hljs-built_in">sub</span><span class="hljs-number">-001.</span>nii.gz<br>│   ├── <span class="hljs-built_in">sub</span><span class="hljs-number">-002.</span>nii.gz<br>│   └── other-file.txt<br>│<br>├── <span class="hljs-built_in">output</span>/               &lt;<span class="hljs-comment">-- 这个文件夹脚本会自动创建，用来存放结果</span><br>│<br>└── batch_n4_correction.py  &lt;<span class="hljs-comment">-- 把上面的Python代码保存成这个文件</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>修改配置：</p>
<p>打开 batch_n4_correction.py 文件，找到 用户配置区域 并根据你的需求修改：</p>
<ul>
<li><code>input_directory</code>: 设置为你的原始数据文件夹路径（示例中是 <code>&#39;./data&#39;</code>）。</li>
<li><code>output_directory</code>: 设置为你希望保存结果的文件夹路径（示例中是 <code>&#39;./output&#39;</code>）。</li>
<li><code>file_prefix</code>: <strong>这是关键</strong>。设置你想要处理的文件的公共前缀。例如，如果你的文件名都是 <code>sub-001.nii.gz</code>, <code>sub-002.nii.gz</code> 等，你的前缀就是 <code>sub-</code>。如果想处理文件夹下所有 <code>.nii.gz</code> 文件，就把它设置成空字符串 <code>&#39;&#39;</code>。</li>
</ul>
</li>
<li><p>运行脚本：</p>
<p>打开终端（Terminal）或命令提示符（Command Prompt），进入到主文件夹（包含脚本和data文件夹的地方），然后运行脚本：</p>
<p>Bash</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">python</span> batch_n4_correction.<span class="hljs-keyword">py</span><br></code></pre></td></tr></table></figure></li>
</ol>
<p>脚本会自动查找 <code>data</code> 文件夹下所有符合前缀要求的文件，逐一进行 N4 校正，并将结果（以 <code>N4_</code> 开头命名）保存到 <code>output</code> 文件夹中。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/" class="category-chain-item">数据处理</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%8E%9F%E5%88%9B/" class="print-no-link">#原创</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>MRI的N4偏场校正</div>
      <div>https://xingdayup.github.io/2025/07/29/N4BiasFieldCorrection/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Jesse Chen</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>July 29, 2025</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/07/29/Skull-Stripping/" title="SynthStrip 颅骨剥离">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">SynthStrip 颅骨剥离</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/06/27/Microglial-expressed-genetic-risk-variants-And-Brain/" title="Microglial-expressed genetic risk variants, cognitive function and brain volume in patients with schizophrenia and healthy controls">
                        <span class="hidden-mobile">Microglial-expressed genetic risk variants, cognitive function and brain volume in patients with schizophrenia and healthy controls</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"vdZLnTIdTwJmBWlW8LgSqJcp-gzGzoHsz","appKey":"SraJp3AuS35E7IyflZgQqEt2","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        Views: 
        <span id="busuanzi_value_site_pv"></span>
        
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        Visitors: 
        <span id="busuanzi_value_site_uv"></span>
        
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
